<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æå®¶å¹´èœ - å¾Œå°ç®¡ç†</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, getDoc, addDoc, setDoc, getDocs, updateDoc, deleteDoc, doc, Timestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        window.firebase = { initializeApp, getFirestore, collection, getDoc, addDoc, setDoc, getDocs, updateDoc, deleteDoc, doc, Timestamp, getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged };
    </script>
    <script src="assets/store.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f4f6f9;
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
        }

        .sidebar-header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 700;
            background-color: rgba(0, 0, 0, 0.1);
        }

        .nav-links {
            list-style: none;
            padding: 20px 0;
        }

        .nav-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--primary-blue);
        }

        /* Main */
        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
        }

        /* Status Cards */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #3498db;
        }

        .status-card h3 {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .status-card .value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        /* Table */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            color: #7f8c8d;
            font-weight: 600;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-new {
            background: var(--status-new-bg);
            color: var(--status-new-text);
        }

        .status-completed {
            background: var(--status-completed-bg);
            color: var(--status-completed-text);
        }

        /* Mobile Label (Hidden on Desktop) */
        .mobile-label {
            display: none;
        }

        /* Modal tweaks */
        #ordersSection,
        #statsSection,
        #menuSection,
        #systemSection {
            animation: fadeIn 0.3s ease-out;
        }

        .detail-row {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px dashed #eee;
            /* Light separator */
            padding-bottom: 10px;
        }

        .modal-actions {
            margin-top: 30px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .detail-label {
            width: 100px;
            font-weight: 700;
            color: #7f8c8d;
        }

        .order-items {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 1000;
                transition: transform 0.3s;
                width: 100%;
                /* Full screen menu on mobile */
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 15px;
                padding-top: 15px;
                /* No fixed header space needed */
            }

            .header {
                position: relative;
                /* Let it flow naturally */
                top: auto;
                left: auto;
                width: 100%;
                background: white;
                z-index: 900;
                padding: 10px 20px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                margin-bottom: 0;
            }

            #sidebarToggle {
                display: block !important;
                background: none;
                border: none;
                font-size: 1.5rem;
                margin-right: 15px;
                cursor: pointer;
            }

            .status-grid {
                grid-template-columns: 1fr;
                /* Stack cards */
            }

            table,
            thead,
            tbody,
            th,
            td,
            tr {
                display: block;
            }

            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            tr {
                border: 1px solid #ccc;
                margin-bottom: 10px;
                border-radius: 8px;
                background: white;
            }

            /* Revert to Block Layout (Safest) */
            td {
                display: block !important;
                position: relative !important;
                padding-left: 10px !important;
                padding-top: 4px !important;
                padding-bottom: 4px !important;
                margin-bottom: 0px;
                /* Tight rows */
                text-align: left !important;
                border: none;
                /* Clean look */
                font-size: 0.85rem;
                /* High density text */
                color: #333 !important;
                min-height: auto;
                line-height: 1.3;
            }

            /* Enable Mobile Labels */
            td .mobile-label {
                display: inline-block !important;
                width: 70px;
                /* More space for content */
                font-weight: bold;
                color: #999;
                font-size: 0.8rem;
                /* Small label */
            }

            td:before {
                display: none !important;
            }

            /* Mobile Modal overrides */
            .detail-row {
                flex-direction: column;
                gap: 5px;
                margin-bottom: 10px;
            }

            .detail-label {
                width: 100%;
                color: #888;
                font-size: 0.85rem;
            }

            .modal-actions {
                flex-direction: column-reverse;
                /* Put primary action (Confirm/Delete) at bottom usually, or stack */
                width: 100%;
            }

            .modal-actions button {
                width: 100%;
                padding: 12px;
                font-size: 1rem;
            }
        }
    </style>
</head>

<body>

    <!-- Login Overlay -->
    <div id="loginOverlay"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:#2c3e50; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white;">
        <h2 style="margin-bottom:20px;">ğŸ”’ å¾Œå°ç®¡ç†ç³»çµ±</h2>
        <div
            style="background:white; padding:30px; border-radius:12px; display:flex; flex-direction:column; gap:15px; width:300px; color:#333;">
            <div class="form-group" style="margin-bottom:0;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">ç®¡ç†å“¡ä¿¡ç®±</label>
                <input type="email" id="adminEmail" class="form-input" placeholder="admin@example.com">
            </div>
            <div class="form-group" style="margin-bottom:0;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">ç®¡ç†å¯†ç¢¼</label>
                <input type="password" id="adminPassword" class="form-input" placeholder="å¯†ç¢¼"
                    onkeydown="if(event.key === 'Enter') checkLogin()">
            </div>
            <button class="btn btn-primary" onclick="checkLogin()" style="width:100%;">ç™»å…¥</button>
            <p id="loginError" style="color:red; font-size:0.9rem; text-align:center; display:none;">âŒ å¯†ç¢¼éŒ¯èª¤</p>
        </div>
    </div>

    <!-- Login Script now in assets/admin.js -->
    <script src="assets/admin.js"></script>

    <aside class="sidebar">
        <div class="sidebar-header">æå®¶å¹´èœ - å¾Œå°</div>
        <ul class="nav-links">
            <li class="nav-item active" onclick="switchTab('orders')" id="nav-orders">ğŸ“‹ è¨‚å–®ç®¡ç†</li>
            <li class="nav-item" onclick="switchTab('stats')" id="nav-stats">ğŸ‘¨â€ğŸ³ å»šæˆ¿çµ±è¨ˆ</li>
            <li class="nav-item" onclick="switchTab('menu')" id="nav-menu">ğŸ² èœå–®è¨­å®š</li>
            <li class="nav-item" onclick="switchTab('system')" id="nav-system">âš™ï¸ ç³»çµ±è¨­å®š</li>
        </ul>
    </aside>

    <main class="main-content">
        <div class="header">
            <div class="page-title-area" style="display:flex; align-items:center;">
                <button id="sidebarToggle">â˜°</button>
                <h1 class="page-title" id="pageTitle">è¨‚å–®ç®¡ç†</h1>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="searchInput" class="form-input" placeholder="ğŸ” æœå°‹è¨‚å–® (ç·¨è™Ÿ/å§“å/é›»è©±)"
                    style="width:250px;">
                <button class="btn btn-outline" onclick="location.reload()">ğŸ”„ é‡æ–°æ•´ç†</button>
            </div>
        </div>

        <!-- Orders Section -->
        <div id="ordersSection">
            <div class="status-grid">
                <div class="status-card" style="border-left-color: #3498db;">
                    <h3>ç¸½è¨‚å–®æ•¸</h3>
                    <div class="value" id="statsTotal">0</div>
                </div>
                <div class="status-card" style="border-left-color: #e74c3c;">
                    <h3>æ–°è¨‚å–®</h3>
                    <div class="value" id="statsNew">0</div>
                </div>
                <div class="status-card" style="border-left-color: #2ecc71;">
                    <h3>ç¸½ç‡Ÿæ”¶</h3>
                    <div class="value" id="statsRevenue">NT$ 0</div>
                </div>
            </div>

            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th onclick="toggleSort('id')" style="cursor:pointer; user-select:none;">
                                è¨‚å–®ç·¨è™Ÿ <span id="sort-id-icon">â–¼</span>
                            </th>
                            <th>è¨‚è³¼äºº</th>
                            <th>é›»è©±</th>
                            <th>ä»˜æ¬¾</th>
                            <th>ç¸½é‡‘é¡</th>
                            <th onclick="toggleSort('status')" style="cursor:pointer; user-select:none;">
                                è¨‚å–®ç‹€æ…‹ <span id="sort-status-icon" style="color:#ccc; font-size:0.8rem;">â–¼</span>
                            </th>
                            <th onclick="toggleSort('time')" style="cursor:pointer; user-select:none;">
                                æ™‚é–“ <span id="sort-time-icon" style="color:#ccc;">â–¼</span>
                            </th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="orderTableBody">
                        <!-- JS Injected -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Kitchen Stats Section -->
        <div id="statsSection" class="hidden">
            <div class="card">
                <div
                    style="padding:20px; border-bottom:1px solid #eee; background:#fff8e1; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h3 style="color:#d35400; margin-bottom:5px;">âš ï¸ å»šæˆ¿å‚™æ–™çµ±è¨ˆ</h3>
                        <p style="color:#666; margin:0;">çµ±è¨ˆæ‰€æœ‰ã€Œæ–°è¨‚å–®ã€èˆ‡ã€Œå·²å®Œæˆã€çš„è¨‚å–®ã€‚</p>
                    </div>
                    <button onclick="printStats()" class="btn btn-outline"
                        style="border-color:#d35400; color:#d35400; background:white;">ğŸ–¨ï¸ åˆ—å°å‚™æ–™å–®</button>
                </div>

                <div style="padding: 20px 20px 10px 20px;">
                    <h4 style="margin-bottom: 5px; color: #555;">ğŸ“ å»šæˆ¿å‚™æ–™æ¸…å–® (ä¾èœå–®ç·¨è™Ÿ)</h4>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>èœè‰²åç¨±</th>
                            <th>ç¸½æ•¸é‡</th>
                        </tr>
                    </thead>
                    <tbody id="kitchenTableBody">
                        <!-- JS Injected -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Menu Section -->
        <div id="menuSection" class="hidden">
            <div style="margin-bottom: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-outline" onclick="openBatchModal()">ğŸ“š æ‰¹é‡åŒ¯å…¥</button>
                <button class="btn btn-primary" onclick="openProductModal()">+ æ–°å¢èœè‰²</button>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>ç·¨è™Ÿ</th>
                            <th>åç¨±</th>
                            <th>åƒ¹æ ¼</th>
                            <th>ç‹€æ…‹</th>
                            <th>æè¿°</th>
                            <th>é †åº</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="menuTableBody">
                        <!-- JS Injected -->
                    </tbody>
                </table>
            </div>
        </div>
        <!-- System Section -->
        <section id="systemSection" class="hidden">
            <!-- Ordering Status (New) -->
            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom:20px;">âš™ï¸ æ¥å–®ç‹€æ…‹è¨­å®š</h3>
                <div
                    style="background:#f9f9f9; padding:20px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; border:1px solid #eee; flex-wrap: wrap; gap: 15px;">
                    <div style="flex: 1 1 300px;">
                        <h4 style="margin-bottom:5px;">å…¨ç«™æ¥å–®æ§åˆ¶</h4>
                        <p style="color:#666; margin:0; line-height:1.5;" id="orderingStatusText">ç›®å‰ç‹€æ…‹ï¼šè®€å–ä¸­...</p>
                    </div>
                    <button id="btnToggleOrdering" class="btn"
                        style="padding:10px 20px; font-size:1rem; font-weight:bold; white-space: nowrap; flex: 1 1 auto;"
                        onclick="toggleOrderingStatus()">
                        è®€å–ä¸­...
                    </button>
                </div>
            </div>

            <h2 style="margin-bottom:20px; color:#333;">è³‡æ–™å®‰å…¨ç®¡ç†</h2>
            <div class="status-grid">
                <div class="status-card" style="border-left: 4px solid #3498db;">
                    <h3>å ±è¡¨åŒ¯å‡º</h3>
                    <p style="color:#666; margin-bottom:15px; font-size:0.9rem;">åŒ¯å‡º Excel (CSV) æ ¼å¼çš„è¨‚å–®æ˜ç´°å ±è¡¨ã€‚</p>
                    <button class="btn" style="background:#3498db; color:white; width:100%; border:none; padding:10px;"
                        onclick="exportToExcel()">ğŸ“Š åŒ¯å‡ºè¨‚å–®å ±è¡¨</button>
                </div>

                <div class="status-card" style="border-left: 4px solid #8e44ad;">
                    <h3>è³‡æ–™å‚™ä»½</h3>
                    <p style="color:#666; margin-bottom:15px; font-size:0.9rem;">å°‡æ‰€æœ‰è¨‚å–®èˆ‡èœå–®è³‡æ–™ä¸‹è¼‰ç‚ºæª”æ¡ˆï¼Œä»¥é˜²ä¸Ÿå¤±ã€‚</p>
                    <button class="btn" style="background:#8e44ad; color:white; width:100%; border:none; padding:10px;"
                        onclick="downloadBackup()">ğŸ“¥ åŒ¯å‡ºè³‡æ–™ (å‚™ä»½)</button>
                </div>

                <div class="status-card" style="border-left: 4px solid #27ae60;">
                    <h3>è³‡æ–™é‚„åŸ</h3>
                    <p style="color:#666; margin-bottom:15px; font-size:0.9rem;">å¾å‚™ä»½æª”æ¡ˆæ¢å¾©è³‡æ–™ (æ³¨æ„ï¼šæœƒè¦†è“‹ç¾æœ‰è³‡æ–™)ã€‚</p>
                    <input type="file" id="importFile" style="display:none" accept=".json"
                        onchange="restoreBackup(this)">
                    <button class="btn" style="background:#27ae60; color:white; width:100%; border:none; padding:10px;"
                        onclick="document.getElementById('importFile').click()">ğŸ“¤ åŒ¯å…¥è³‡æ–™ (é‚„åŸ)</button>
                </div>

                <div class="status-card" style="border-left: 4px solid #c0392b; display: none;">
                    <h3>é‡ç½®ç³»çµ±</h3>
                    <p style="color:#666; margin-bottom:15px; font-size:0.9rem;">æ¸…é™¤æ‰€æœ‰è¨‚å–®èˆ‡è¨­å®šï¼Œå›åˆ°åˆå§‹ç‹€æ…‹ã€‚</p>
                    <button class="btn" style="background:#c0392b; color:white; width:100%; border:none; padding:10px;"
                        onclick="if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼')) { localStorage.clear(); location.reload(); }">âš ï¸
                        æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Detail Modal -->
    <div class="modal" id="orderModal" onclick="if(event.target === this) closeModal()">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header">
                <h2 id="modalId" style="margin:0;"></h2>
                <span onclick="closeModal()"
                    style="cursor:pointer; font-size:1.5rem; padding: 0 10px; line-height: 1;">Ã—</span>
            </div>

            <!-- Info Grid -->
            <div class="modal-info-grid">
                <div class="modal-info-label">è¨‚è³¼äºº</div>
                <div class="modal-info-value" id="modalName"></div>

                <div class="modal-info-label">é›»è©±</div>
                <div class="modal-info-value" id="modalPhone"></div>

                <div class="modal-info-label">å‚™è¨»</div>
                <div class="modal-info-value modal-note" id="modalNote"></div>
            </div>

            <!-- Items -->
            <h4 style="margin-bottom:10px;">è¨‚è³¼æ˜ç´°</h4>
            <div class="modal-items-container" id="modalItems"></div>

            <!-- Total -->
            <div class="modal-total-section">
                ç¸½è¨ˆ: <span id="modalTotal"></span>
            </div>

            <!-- Actions -->
            <div class="modal-actions-container">
                <!-- Management Group -->
                <div class="action-group-manage">
                    <button class="btn btn-outline" style="border-color:#ccc; color:#666;"
                        onclick="closeModal()">é—œé–‰</button>
                    <button class="btn btn-outline" style="border-color:#3498db; color:#3498db;"
                        onclick="editCurrentOrder()">âœï¸ ä¿®æ”¹</button>
                    <button class="btn btn-outline" style="border-color:#e74c3c; color:#e74c3c;"
                        onclick="deleteCurrentOrder()">ğŸ—‘ï¸ åˆªé™¤</button>
                </div>

                <!-- Status Workflow Group -->
                <div class="action-group-status">
                    <button class="btn" style="background:#f39c12; color:white; border:none; padding:8px 15px;"
                        onclick="updateStatus('processing')">â³ è™•ç†ä¸­</button>
                    <button class="btn" style="background:#3498db; color:white; border:none; padding:8px 15px;"
                        onclick="updateStatus('confirmed')">ğŸ†— å·²ç¢ºèª</button>
                    <button class="btn" style="background:#27ae60; color:white; border:none; padding:8px 15px;"
                        onclick="updateStatus('completed')">âœ… å·²å®Œæˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;" id="productModalTitle">æ–°å¢èœè‰²</h2>
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="pId">
                <div class="form-group">
                    <label class="form-label">èœè‰²åç¨±</label>
                    <input type="text" class="form-input" id="pName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">åƒ¹æ ¼</label>
                    <input type="number" class="form-input" id="pPrice" required>
                </div>
                <div class="form-group">
                    <label class="form-label">æè¿°</label>
                    <textarea class="form-textarea" id="pDesc"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" onclick="closeProductModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Batch Import Modal -->
    <div class="modal" id="batchModal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 style="margin-bottom: 20px;">æ‰¹é‡åŒ¯å…¥èœè‰²</h2>
            <div
                style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 15px; font-size: 0.9rem; color: #666;">
                è«‹å°‡ Excel æˆ–æ–‡å­—è³‡æ–™è²¼ä¸Šã€‚æ¯è¡Œä¸€ç­†ã€‚<br>
                <strong>æ ¼å¼ç¯„ä¾‹ï¼š</strong><br>
                ä½›è·³ç‰†, 1280, é ‚ç´šé£Ÿææ…¢ç«ç‡‰ç…®<br>
                ç´…ç‡’ç…å­é ­, 680<br>
                (åˆ†éš”ç¬¦è™Ÿå¯ä»¥ç”¨é€—è™Ÿæˆ– Tab)
            </div>
            <textarea id="batchInput" class="form-textarea" style="height: 200px; font-family: monospace;"
                placeholder="åç¨±, åƒ¹æ ¼, æè¿°..."></textarea>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                <button type="button" class="btn btn-outline" onclick="closeBatchModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveBatch()">é–‹å§‹åŒ¯å…¥</button>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="assets/store.js"></script>
    <script src="assets/admin.js"></script>
</body>

</html>